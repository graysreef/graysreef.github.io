---
title: "MBON Habitat Prep"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

```{r setup}
library(sp)
library(rgdal)
library(raster)
library(tidyverse)
library(stringr)
library(knitr)
```


## Raster Manipulation

- [8. Raster data manipulation](http://rspatial.org/spatial/rst/8-rastermanip.html)

```{r}
dir_tif = 'H:/MBON/habitats_halpern2015_knb/data'
tifs = setdiff(
  list.files(dir_tif, '*.\\.tif$'),
  c('deep_waters_lzw.tif','habitat_num.tif','surface_waters_lzw.tif'))

s = stack(sprintf('%s/%s', dir_tif, tifs))
names(s) = str_replace(names(s), '_lzw', '')


d = data_frame(
  hab_name = names(s)) %>%
  mutate(
    hab_id   = row_number()) # View(d)

study = list(
  southeast = readOGR('H:/MBON/study_area.gdb','southeast'),
  socal     = readOGR('H:/MBON/study_area.gdb','socal'))


for (i in 1:nrow(d)){ # i=18
  # set vars
  lyr     = d$hab_name[i]
  id      = d$hab_id[i]
  lyr_num = sprintf('%s_num', lyr)
  
  # define layer as numeric id, otherwise 0
  cat(sprintf('%02d of %d: %s -> %s: 1 -> %d, otherwise 0 -- %s\n', i, nrow(d), lyr, lyr_num, id, Sys.time()))
  r = (1 - is.na(raster(s, lyr))) * id
  s = stack(s, r)
  writeRaster(
    r, 
    sprintf('H:/MBON/tmp/%s.tif', lyr_num), 
    options=c("COMPRESS=LZW","TFW=YES"), overwrite=T)
  
  # crop to study areas
  for (area in names(study)){ # area = names(study)[2]
    cat(sprintf('  crop to %s -- %s\n', area, Sys.time()))
    r_area = crop(r, extent(study[[area]]))
    
    writeRaster(
      r_area, 
      sprintf('H:/MBON/tmp/%s_%s.tif', lyr_num, area), 
      options=c("COMPRESS=LZW","TFW=YES"), overwrite=T)
  }
}

```


```{r reclassify}
##figure out how to stick in for loop
t <- raster("H:/MBON/tmp/suspension_reef_num.tif")
m <- c(0,0,0, 18,18,400000)
rclmat <- matrix(m, ncol=3, byrow = TRUE)
rc <- reclassify(t, rclmat)
writeRaster(rc, filename = "H:/MBON/reclass/suspension_reef_num.tif")
```


```{r reclassify & crop}
tif_in    = 'H:/MBON/tmp/suspension_reef_num.tif'
tif_socal = 'H:/MBON/reclass/suspension_reef_num_socal.tif'
area      = 'socal'

##figure out how to stick in for loop
r = raster(tif_in)
m = matrix(
  c(0,0,0, 18,18,400000),
  ncol=3, byrow = TRUE)
r_r  = reclassify(r, m)

r_rc = crop(r_r, extent(study[[area]]))
writeRaster(r_rc, filename = tif_socal)

```

